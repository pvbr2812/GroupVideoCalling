{"ast":null,"code":"// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\nimport { AbortError } from \"@azure/abort-controller\";\nimport { HttpHeaders } from \"./httpHeaders\";\nimport { RestError } from \"./restError\";\n/**\n * A HttpClient implementation that uses XMLHttpRequest to send HTTP requests.\n */\n\nvar XhrHttpClient =\n/** @class */\nfunction () {\n  function XhrHttpClient() {}\n\n  XhrHttpClient.prototype.sendRequest = function (request) {\n    var _a;\n\n    var xhr = new XMLHttpRequest();\n\n    if (request.proxySettings) {\n      throw new Error(\"HTTP proxy is not supported in browser environment\");\n    }\n\n    var abortSignal = request.abortSignal;\n\n    if (abortSignal) {\n      if (abortSignal.aborted) {\n        return Promise.reject(new AbortError(\"The operation was aborted.\"));\n      }\n\n      var listener_1 = function () {\n        xhr.abort();\n      };\n\n      abortSignal.addEventListener(\"abort\", listener_1);\n      xhr.addEventListener(\"readystatechange\", function () {\n        if (xhr.readyState === XMLHttpRequest.DONE) {\n          abortSignal.removeEventListener(\"abort\", listener_1);\n        }\n      });\n    }\n\n    addProgressListener(xhr.upload, request.onUploadProgress);\n    addProgressListener(xhr, request.onDownloadProgress);\n\n    if (request.formData) {\n      var formData = request.formData;\n      var requestForm_1 = new FormData();\n\n      var appendFormValue = function (key, value) {\n        if (value && Object.prototype.hasOwnProperty.call(value, \"value\") && Object.prototype.hasOwnProperty.call(value, \"options\")) {\n          requestForm_1.append(key, value.value, value.options);\n        } else {\n          requestForm_1.append(key, value);\n        }\n      };\n\n      for (var _i = 0, _b = Object.keys(formData); _i < _b.length; _i++) {\n        var formKey = _b[_i];\n        var formValue = formData[formKey];\n\n        if (Array.isArray(formValue)) {\n          for (var j = 0; j < formValue.length; j++) {\n            appendFormValue(formKey, formValue[j]);\n          }\n        } else {\n          appendFormValue(formKey, formValue);\n        }\n      }\n\n      request.body = requestForm_1;\n      request.formData = undefined;\n      var contentType = request.headers.get(\"Content-Type\");\n\n      if (contentType && contentType.indexOf(\"multipart/form-data\") !== -1) {\n        // browser will automatically apply a suitable content-type header\n        request.headers.remove(\"Content-Type\");\n      }\n    }\n\n    xhr.open(request.method, request.url);\n    xhr.timeout = request.timeout;\n    xhr.withCredentials = request.withCredentials;\n\n    for (var _c = 0, _d = request.headers.headersArray(); _c < _d.length; _c++) {\n      var header = _d[_c];\n      xhr.setRequestHeader(header.name, header.value);\n    }\n\n    xhr.responseType = ((_a = request.streamResponseStatusCodes) === null || _a === void 0 ? void 0 : _a.size) || request.streamResponseBody ? \"blob\" : \"text\"; // tslint:disable-next-line:no-null-keyword\n\n    xhr.send(request.body === undefined ? null : request.body);\n\n    if (xhr.responseType === \"blob\") {\n      return new Promise(function (resolve, reject) {\n        handleBlobResponse(xhr, request, resolve, reject);\n        rejectOnTerminalEvent(request, xhr, reject);\n      });\n    } else {\n      return new Promise(function (resolve, reject) {\n        xhr.addEventListener(\"load\", function () {\n          return resolve({\n            request: request,\n            status: xhr.status,\n            headers: parseHeaders(xhr),\n            bodyAsText: xhr.responseText\n          });\n        });\n        rejectOnTerminalEvent(request, xhr, reject);\n      });\n    }\n  };\n\n  return XhrHttpClient;\n}();\n\nexport { XhrHttpClient };\n\nfunction handleBlobResponse(xhr, request, res, rej) {\n  xhr.addEventListener(\"readystatechange\", function () {\n    var _a; // Resolve as soon as headers are loaded\n\n\n    if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) {\n      if (request.streamResponseBody || ((_a = request.streamResponseStatusCodes) === null || _a === void 0 ? void 0 : _a.has(xhr.status))) {\n        var blobBody = new Promise(function (resolve, reject) {\n          xhr.addEventListener(\"load\", function () {\n            resolve(xhr.response);\n          });\n          rejectOnTerminalEvent(request, xhr, reject);\n        });\n        res({\n          request: request,\n          status: xhr.status,\n          headers: parseHeaders(xhr),\n          blobBody: blobBody\n        });\n      } else {\n        xhr.addEventListener(\"load\", function () {\n          // xhr.response is of Blob type if the request is sent with xhr.responseType === \"blob\"\n          // but the status code is not one of the stream response status codes,\n          // so treat it as text and convert from Blob to text\n          if (xhr.response) {\n            // Blob.text() is not supported in IE so using FileReader instead\n            var reader_1 = new FileReader();\n\n            reader_1.onload = function (e) {\n              var _a;\n\n              var text = (_a = e.target) === null || _a === void 0 ? void 0 : _a.result;\n              res({\n                request: request,\n                status: xhr.status,\n                headers: parseHeaders(xhr),\n                bodyAsText: text\n              });\n            };\n\n            reader_1.onerror = function (_e) {\n              rej(reader_1.error);\n            };\n\n            reader_1.readAsText(xhr.response, \"UTF-8\");\n          } else {\n            res({\n              request: request,\n              status: xhr.status,\n              headers: parseHeaders(xhr)\n            });\n          }\n        });\n      }\n    }\n  });\n}\n\nfunction addProgressListener(xhr, listener) {\n  if (listener) {\n    xhr.addEventListener(\"progress\", function (rawEvent) {\n      return listener({\n        loadedBytes: rawEvent.loaded\n      });\n    });\n  }\n} // exported locally for testing\n\n\nexport function parseHeaders(xhr) {\n  var responseHeaders = new HttpHeaders();\n  var headerLines = xhr.getAllResponseHeaders().trim().split(/[\\r\\n]+/);\n\n  for (var _i = 0, headerLines_1 = headerLines; _i < headerLines_1.length; _i++) {\n    var line = headerLines_1[_i];\n    var index = line.indexOf(\":\");\n    var headerName = line.slice(0, index);\n    var headerValue = line.slice(index + 2);\n    responseHeaders.set(headerName, headerValue);\n  }\n\n  return responseHeaders;\n}\n\nfunction rejectOnTerminalEvent(request, xhr, reject) {\n  xhr.addEventListener(\"error\", function () {\n    return reject(new RestError(\"Failed to send request to \" + request.url, RestError.REQUEST_SEND_ERROR, undefined, request));\n  });\n  var abortError = new AbortError(\"The operation was aborted.\");\n  xhr.addEventListener(\"abort\", function () {\n    return reject(abortError);\n  });\n  xhr.addEventListener(\"timeout\", function () {\n    return reject(abortError);\n  });\n}","map":{"version":3,"sources":["../../src/xhrHttpClient.ts"],"names":[],"mappings":"AAAA;AACA;AAEA,SAAS,UAAT,QAA2B,yBAA3B;AAEA,SAAS,WAAT,QAA6C,eAA7C;AAGA,SAAS,SAAT,QAA0B,aAA1B;AAEA;;AAEG;;AACH,IAAA,aAAA;AAAA;AAAA,YAAA;AAAA,WAAA,aAAA,GAAA,CA8FC;;AA7FQ,EAAA,aAAA,CAAA,SAAA,CAAA,WAAA,GAAP,UAAmB,OAAnB,EAA2C;;;AACzC,QAAM,GAAG,GAAG,IAAI,cAAJ,EAAZ;;AAEA,QAAI,OAAO,CAAC,aAAZ,EAA2B;AACzB,YAAM,IAAI,KAAJ,CAAU,oDAAV,CAAN;AACD;;AAED,QAAM,WAAW,GAAG,OAAO,CAAC,WAA5B;;AACA,QAAI,WAAJ,EAAiB;AACf,UAAI,WAAW,CAAC,OAAhB,EAAyB;AACvB,eAAO,OAAO,CAAC,MAAR,CAAe,IAAI,UAAJ,CAAe,4BAAf,CAAf,CAAP;AACD;;AAED,UAAM,UAAQ,GAAG,YAAA;AACf,QAAA,GAAG,CAAC,KAAJ;AACD,OAFD;;AAGA,MAAA,WAAW,CAAC,gBAAZ,CAA6B,OAA7B,EAAsC,UAAtC;AACA,MAAA,GAAG,CAAC,gBAAJ,CAAqB,kBAArB,EAAyC,YAAA;AACvC,YAAI,GAAG,CAAC,UAAJ,KAAmB,cAAc,CAAC,IAAtC,EAA4C;AAC1C,UAAA,WAAW,CAAC,mBAAZ,CAAgC,OAAhC,EAAyC,UAAzC;AACD;AACF,OAJD;AAKD;;AAED,IAAA,mBAAmB,CAAC,GAAG,CAAC,MAAL,EAAa,OAAO,CAAC,gBAArB,CAAnB;AACA,IAAA,mBAAmB,CAAC,GAAD,EAAM,OAAO,CAAC,kBAAd,CAAnB;;AAEA,QAAI,OAAO,CAAC,QAAZ,EAAsB;AACpB,UAAM,QAAQ,GAAG,OAAO,CAAC,QAAzB;AACA,UAAM,aAAW,GAAG,IAAI,QAAJ,EAApB;;AACA,UAAM,eAAe,GAAG,UAAC,GAAD,EAAc,KAAd,EAAwB;AAC9C,YACE,KAAK,IACL,MAAM,CAAC,SAAP,CAAiB,cAAjB,CAAgC,IAAhC,CAAqC,KAArC,EAA4C,OAA5C,CADA,IAEA,MAAM,CAAC,SAAP,CAAiB,cAAjB,CAAgC,IAAhC,CAAqC,KAArC,EAA4C,SAA5C,CAHF,EAIE;AACA,UAAA,aAAW,CAAC,MAAZ,CAAmB,GAAnB,EAAwB,KAAK,CAAC,KAA9B,EAAqC,KAAK,CAAC,OAA3C;AACD,SAND,MAMO;AACL,UAAA,aAAW,CAAC,MAAZ,CAAmB,GAAnB,EAAwB,KAAxB;AACD;AACF,OAVD;;AAWA,WAAsB,IAAA,EAAA,GAAA,CAAA,EAAA,EAAA,GAAA,MAAM,CAAC,IAAP,CAAY,QAAZ,CAAtB,EAAsB,EAAA,GAAA,EAAA,CAAA,MAAtB,EAAsB,EAAA,EAAtB,EAA6C;AAAxC,YAAM,OAAO,GAAA,EAAA,CAAA,EAAA,CAAb;AACH,YAAM,SAAS,GAAG,QAAQ,CAAC,OAAD,CAA1B;;AACA,YAAI,KAAK,CAAC,OAAN,CAAc,SAAd,CAAJ,EAA8B;AAC5B,eAAK,IAAI,CAAC,GAAG,CAAb,EAAgB,CAAC,GAAG,SAAS,CAAC,MAA9B,EAAsC,CAAC,EAAvC,EAA2C;AACzC,YAAA,eAAe,CAAC,OAAD,EAAU,SAAS,CAAC,CAAD,CAAnB,CAAf;AACD;AACF,SAJD,MAIO;AACL,UAAA,eAAe,CAAC,OAAD,EAAU,SAAV,CAAf;AACD;AACF;;AAED,MAAA,OAAO,CAAC,IAAR,GAAe,aAAf;AACA,MAAA,OAAO,CAAC,QAAR,GAAmB,SAAnB;AACA,UAAM,WAAW,GAAG,OAAO,CAAC,OAAR,CAAgB,GAAhB,CAAoB,cAApB,CAApB;;AACA,UAAI,WAAW,IAAI,WAAW,CAAC,OAAZ,CAAoB,qBAApB,MAA+C,CAAC,CAAnE,EAAsE;AACpE;AACA,QAAA,OAAO,CAAC,OAAR,CAAgB,MAAhB,CAAuB,cAAvB;AACD;AACF;;AAED,IAAA,GAAG,CAAC,IAAJ,CAAS,OAAO,CAAC,MAAjB,EAAyB,OAAO,CAAC,GAAjC;AACA,IAAA,GAAG,CAAC,OAAJ,GAAc,OAAO,CAAC,OAAtB;AACA,IAAA,GAAG,CAAC,eAAJ,GAAsB,OAAO,CAAC,eAA9B;;AACA,SAAqB,IAAA,EAAA,GAAA,CAAA,EAAA,EAAA,GAAA,OAAO,CAAC,OAAR,CAAgB,YAAhB,EAArB,EAAqB,EAAA,GAAA,EAAA,CAAA,MAArB,EAAqB,EAAA,EAArB,EAAqD;AAAhD,UAAM,MAAM,GAAA,EAAA,CAAA,EAAA,CAAZ;AACH,MAAA,GAAG,CAAC,gBAAJ,CAAqB,MAAM,CAAC,IAA5B,EAAkC,MAAM,CAAC,KAAzC;AACD;;AAED,IAAA,GAAG,CAAC,YAAJ,GACE,CAAA,CAAA,EAAA,GAAA,OAAO,CAAC,yBAAR,MAAiC,IAAjC,IAAiC,EAAA,KAAA,KAAA,CAAjC,GAAiC,KAAA,CAAjC,GAAiC,EAAA,CAAE,IAAnC,KAA2C,OAAO,CAAC,kBAAnD,GAAwE,MAAxE,GAAiF,MADnF,CApEyC,CAuEzC;;AACA,IAAA,GAAG,CAAC,IAAJ,CAAS,OAAO,CAAC,IAAR,KAAiB,SAAjB,GAA6B,IAA7B,GAAoC,OAAO,CAAC,IAArD;;AAEA,QAAI,GAAG,CAAC,YAAJ,KAAqB,MAAzB,EAAiC;AAC/B,aAAO,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAgB;AACjC,QAAA,kBAAkB,CAAC,GAAD,EAAM,OAAN,EAAe,OAAf,EAAwB,MAAxB,CAAlB;AACA,QAAA,qBAAqB,CAAC,OAAD,EAAU,GAAV,EAAe,MAAf,CAArB;AACD,OAHM,CAAP;AAID,KALD,MAKO;AACL,aAAO,IAAI,OAAJ,CAAY,UAAS,OAAT,EAAkB,MAAlB,EAAwB;AACzC,QAAA,GAAG,CAAC,gBAAJ,CAAqB,MAArB,EAA6B,YAAA;AAC3B,iBAAA,OAAO,CAAC;AACN,YAAA,OAAO,EAAA,OADD;AAEN,YAAA,MAAM,EAAE,GAAG,CAAC,MAFN;AAGN,YAAA,OAAO,EAAE,YAAY,CAAC,GAAD,CAHf;AAIN,YAAA,UAAU,EAAE,GAAG,CAAC;AAJV,WAAD,CAAP;AAKE,SANJ;AAQA,QAAA,qBAAqB,CAAC,OAAD,EAAU,GAAV,EAAe,MAAf,CAArB;AACD,OAVM,CAAP;AAWD;AACF,GA5FM;;AA6FT,SAAA,aAAA;AAAC,CA9FD,EAAA;;;;AAgGA,SAAS,kBAAT,CACE,GADF,EAEE,OAFF,EAGE,GAHF,EAIE,GAJF,EAI6B;AAE3B,EAAA,GAAG,CAAC,gBAAJ,CAAqB,kBAArB,EAAyC,YAAA;WAAA,CACvC;;;AACA,QAAI,GAAG,CAAC,UAAJ,KAAmB,cAAc,CAAC,gBAAtC,EAAwD;AACtD,UAAI,OAAO,CAAC,kBAAR,KAA0B,CAAA,EAAA,GAAI,OAAO,CAAC,yBAAZ,MAAqC,IAArC,IAAqC,EAAA,KAAA,KAAA,CAArC,GAAqC,KAAA,CAArC,GAAqC,EAAA,CAAE,GAAF,CAAM,GAAG,CAAC,MAAV,CAA/D,CAAJ,EAAsF;AACpF,YAAM,QAAQ,GAAG,IAAI,OAAJ,CAAkB,UAAC,OAAD,EAAU,MAAV,EAAgB;AACjD,UAAA,GAAG,CAAC,gBAAJ,CAAqB,MAArB,EAA6B,YAAA;AAC3B,YAAA,OAAO,CAAC,GAAG,CAAC,QAAL,CAAP;AACD,WAFD;AAGA,UAAA,qBAAqB,CAAC,OAAD,EAAU,GAAV,EAAe,MAAf,CAArB;AACD,SALgB,CAAjB;AAMA,QAAA,GAAG,CAAC;AACF,UAAA,OAAO,EAAA,OADL;AAEF,UAAA,MAAM,EAAE,GAAG,CAAC,MAFV;AAGF,UAAA,OAAO,EAAE,YAAY,CAAC,GAAD,CAHnB;AAIF,UAAA,QAAQ,EAAA;AAJN,SAAD,CAAH;AAMD,OAbD,MAaO;AACL,QAAA,GAAG,CAAC,gBAAJ,CAAqB,MAArB,EAA6B,YAAA;AAC3B;AACA;AACA;AACA,cAAI,GAAG,CAAC,QAAR,EAAkB;AAChB;AACA,gBAAM,QAAM,GAAG,IAAI,UAAJ,EAAf;;AACA,YAAA,QAAM,CAAC,MAAP,GAAgB,UAAS,CAAT,EAAU;;;AACxB,kBAAM,IAAI,GAAG,CAAA,EAAA,GAAA,CAAC,CAAC,MAAF,MAAQ,IAAR,IAAQ,EAAA,KAAA,KAAA,CAAR,GAAQ,KAAA,CAAR,GAAQ,EAAA,CAAE,MAAvB;AACA,cAAA,GAAG,CAAC;AACF,gBAAA,OAAO,EAAA,OADL;AAEF,gBAAA,MAAM,EAAE,GAAG,CAAC,MAFV;AAGF,gBAAA,OAAO,EAAE,YAAY,CAAC,GAAD,CAHnB;AAIF,gBAAA,UAAU,EAAE;AAJV,eAAD,CAAH;AAMD,aARD;;AASA,YAAA,QAAM,CAAC,OAAP,GAAiB,UAAS,EAAT,EAAW;AAC1B,cAAA,GAAG,CAAC,QAAM,CAAC,KAAR,CAAH;AACD,aAFD;;AAGA,YAAA,QAAM,CAAC,UAAP,CAAkB,GAAG,CAAC,QAAtB,EAAgC,OAAhC;AACD,WAhBD,MAgBO;AACL,YAAA,GAAG,CAAC;AACF,cAAA,OAAO,EAAA,OADL;AAEF,cAAA,MAAM,EAAE,GAAG,CAAC,MAFV;AAGF,cAAA,OAAO,EAAE,YAAY,CAAC,GAAD;AAHnB,aAAD,CAAH;AAKD;AACF,SA3BD;AA4BD;AACF;AACF,GA/CD;AAgDD;;AAED,SAAS,mBAAT,CACE,GADF,EAEE,QAFF,EAEsD;AAEpD,MAAI,QAAJ,EAAc;AACZ,IAAA,GAAG,CAAC,gBAAJ,CAAqB,UAArB,EAAiC,UAAC,QAAD,EAAS;AACxC,aAAA,QAAQ,CAAC;AACP,QAAA,WAAW,EAAE,QAAQ,CAAC;AADf,OAAD,CAAR;AAEE,KAHJ;AAKD;AACF,C,CAED;;;AACA,OAAM,SAAU,YAAV,CAAuB,GAAvB,EAA0C;AAC9C,MAAM,eAAe,GAAG,IAAI,WAAJ,EAAxB;AACA,MAAM,WAAW,GAAG,GAAG,CACpB,qBADiB,GAEjB,IAFiB,GAGjB,KAHiB,CAGX,SAHW,CAApB;;AAIA,OAAmB,IAAA,EAAA,GAAA,CAAA,EAAA,aAAA,GAAA,WAAnB,EAAmB,EAAA,GAAA,aAAA,CAAA,MAAnB,EAAmB,EAAA,EAAnB,EAAgC;AAA3B,QAAM,IAAI,GAAA,aAAA,CAAA,EAAA,CAAV;AACH,QAAM,KAAK,GAAG,IAAI,CAAC,OAAL,CAAa,GAAb,CAAd;AACA,QAAM,UAAU,GAAG,IAAI,CAAC,KAAL,CAAW,CAAX,EAAc,KAAd,CAAnB;AACA,QAAM,WAAW,GAAG,IAAI,CAAC,KAAL,CAAW,KAAK,GAAG,CAAnB,CAApB;AACA,IAAA,eAAe,CAAC,GAAhB,CAAoB,UAApB,EAAgC,WAAhC;AACD;;AACD,SAAO,eAAP;AACD;;AAED,SAAS,qBAAT,CACE,OADF,EAEE,GAFF,EAGE,MAHF,EAG4B;AAE1B,EAAA,GAAG,CAAC,gBAAJ,CAAqB,OAArB,EAA8B,YAAA;AAC5B,WAAA,MAAM,CACJ,IAAI,SAAJ,CACE,+BAA6B,OAAO,CAAC,GADvC,EAEE,SAAS,CAAC,kBAFZ,EAGE,SAHF,EAIE,OAJF,CADI,CAAN;AAOC,GARH;AAUA,MAAM,UAAU,GAAG,IAAI,UAAJ,CAAe,4BAAf,CAAnB;AACA,EAAA,GAAG,CAAC,gBAAJ,CAAqB,OAArB,EAA8B,YAAA;AAAM,WAAA,MAAM,CAAN,UAAM,CAAN;AAAkB,GAAtD;AACA,EAAA,GAAG,CAAC,gBAAJ,CAAqB,SAArB,EAAgC,YAAA;AAAM,WAAA,MAAM,CAAN,UAAM,CAAN;AAAkB,GAAxD;AACD","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n\nimport { AbortError } from \"@azure/abort-controller\";\nimport { HttpClient } from \"./httpClient\";\nimport { HttpHeaders, HttpHeadersLike } from \"./httpHeaders\";\nimport { WebResourceLike, TransferProgressEvent } from \"./webResource\";\nimport { HttpOperationResponse } from \"./httpOperationResponse\";\nimport { RestError } from \"./restError\";\n\n/**\n * A HttpClient implementation that uses XMLHttpRequest to send HTTP requests.\n */\nexport class XhrHttpClient implements HttpClient {\n  public sendRequest(request: WebResourceLike): Promise<HttpOperationResponse> {\n    const xhr = new XMLHttpRequest();\n\n    if (request.proxySettings) {\n      throw new Error(\"HTTP proxy is not supported in browser environment\");\n    }\n\n    const abortSignal = request.abortSignal;\n    if (abortSignal) {\n      if (abortSignal.aborted) {\n        return Promise.reject(new AbortError(\"The operation was aborted.\"));\n      }\n\n      const listener = (): void => {\n        xhr.abort();\n      };\n      abortSignal.addEventListener(\"abort\", listener);\n      xhr.addEventListener(\"readystatechange\", () => {\n        if (xhr.readyState === XMLHttpRequest.DONE) {\n          abortSignal.removeEventListener(\"abort\", listener);\n        }\n      });\n    }\n\n    addProgressListener(xhr.upload, request.onUploadProgress);\n    addProgressListener(xhr, request.onDownloadProgress);\n\n    if (request.formData) {\n      const formData = request.formData;\n      const requestForm = new FormData();\n      const appendFormValue = (key: string, value: any): void => {\n        if (\n          value &&\n          Object.prototype.hasOwnProperty.call(value, \"value\") &&\n          Object.prototype.hasOwnProperty.call(value, \"options\")\n        ) {\n          requestForm.append(key, value.value, value.options);\n        } else {\n          requestForm.append(key, value);\n        }\n      };\n      for (const formKey of Object.keys(formData)) {\n        const formValue = formData[formKey];\n        if (Array.isArray(formValue)) {\n          for (let j = 0; j < formValue.length; j++) {\n            appendFormValue(formKey, formValue[j]);\n          }\n        } else {\n          appendFormValue(formKey, formValue);\n        }\n      }\n\n      request.body = requestForm;\n      request.formData = undefined;\n      const contentType = request.headers.get(\"Content-Type\");\n      if (contentType && contentType.indexOf(\"multipart/form-data\") !== -1) {\n        // browser will automatically apply a suitable content-type header\n        request.headers.remove(\"Content-Type\");\n      }\n    }\n\n    xhr.open(request.method, request.url);\n    xhr.timeout = request.timeout;\n    xhr.withCredentials = request.withCredentials;\n    for (const header of request.headers.headersArray()) {\n      xhr.setRequestHeader(header.name, header.value);\n    }\n\n    xhr.responseType =\n      request.streamResponseStatusCodes?.size || request.streamResponseBody ? \"blob\" : \"text\";\n\n    // tslint:disable-next-line:no-null-keyword\n    xhr.send(request.body === undefined ? null : request.body);\n\n    if (xhr.responseType === \"blob\") {\n      return new Promise((resolve, reject) => {\n        handleBlobResponse(xhr, request, resolve, reject);\n        rejectOnTerminalEvent(request, xhr, reject);\n      });\n    } else {\n      return new Promise(function(resolve, reject) {\n        xhr.addEventListener(\"load\", () =>\n          resolve({\n            request,\n            status: xhr.status,\n            headers: parseHeaders(xhr),\n            bodyAsText: xhr.responseText\n          })\n        );\n        rejectOnTerminalEvent(request, xhr, reject);\n      });\n    }\n  }\n}\n\nfunction handleBlobResponse(\n  xhr: XMLHttpRequest,\n  request: WebResourceLike,\n  res: (value: HttpOperationResponse | PromiseLike<HttpOperationResponse>) => void,\n  rej: (reason?: any) => void\n): void {\n  xhr.addEventListener(\"readystatechange\", () => {\n    // Resolve as soon as headers are loaded\n    if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) {\n      if (request.streamResponseBody || request.streamResponseStatusCodes?.has(xhr.status)) {\n        const blobBody = new Promise<Blob>((resolve, reject) => {\n          xhr.addEventListener(\"load\", () => {\n            resolve(xhr.response);\n          });\n          rejectOnTerminalEvent(request, xhr, reject);\n        });\n        res({\n          request,\n          status: xhr.status,\n          headers: parseHeaders(xhr),\n          blobBody\n        });\n      } else {\n        xhr.addEventListener(\"load\", () => {\n          // xhr.response is of Blob type if the request is sent with xhr.responseType === \"blob\"\n          // but the status code is not one of the stream response status codes,\n          // so treat it as text and convert from Blob to text\n          if (xhr.response) {\n            // Blob.text() is not supported in IE so using FileReader instead\n            const reader = new FileReader();\n            reader.onload = function(e) {\n              const text = e.target?.result as string;\n              res({\n                request,\n                status: xhr.status,\n                headers: parseHeaders(xhr),\n                bodyAsText: text\n              });\n            };\n            reader.onerror = function(_e) {\n              rej(reader.error);\n            };\n            reader.readAsText(xhr.response, \"UTF-8\");\n          } else {\n            res({\n              request,\n              status: xhr.status,\n              headers: parseHeaders(xhr)\n            });\n          }\n        });\n      }\n    }\n  });\n}\n\nfunction addProgressListener(\n  xhr: XMLHttpRequestEventTarget,\n  listener?: (progress: TransferProgressEvent) => void\n): void {\n  if (listener) {\n    xhr.addEventListener(\"progress\", (rawEvent) =>\n      listener({\n        loadedBytes: rawEvent.loaded\n      })\n    );\n  }\n}\n\n// exported locally for testing\nexport function parseHeaders(xhr: XMLHttpRequest): HttpHeadersLike {\n  const responseHeaders = new HttpHeaders();\n  const headerLines = xhr\n    .getAllResponseHeaders()\n    .trim()\n    .split(/[\\r\\n]+/);\n  for (const line of headerLines) {\n    const index = line.indexOf(\":\");\n    const headerName = line.slice(0, index);\n    const headerValue = line.slice(index + 2);\n    responseHeaders.set(headerName, headerValue);\n  }\n  return responseHeaders;\n}\n\nfunction rejectOnTerminalEvent(\n  request: WebResourceLike,\n  xhr: XMLHttpRequest,\n  reject: (err: any) => void\n): void {\n  xhr.addEventListener(\"error\", () =>\n    reject(\n      new RestError(\n        `Failed to send request to ${request.url}`,\n        RestError.REQUEST_SEND_ERROR,\n        undefined,\n        request\n      )\n    )\n  );\n  const abortError = new AbortError(\"The operation was aborted.\");\n  xhr.addEventListener(\"abort\", () => reject(abortError));\n  xhr.addEventListener(\"timeout\", () => reject(abortError));\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}